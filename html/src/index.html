<html>
<head>
    <title>speedtest</title>
    <style>
input[type="range"] {
    width: 100%;
}
#progress {
    width: 100%;
    border-style: solid;
}
#progressBar {
    width: 1%;
    background-color: black;
    height: 30px;
}
    </style>
</head>
<body>
<label>
    <input type="range" id="payloadRange" min="0" max="100000000000" value="0">
    <input type="number" id="payloadNumber">
    <input type="button" id="uploadButton" value="Upload">
    <input type="button" id="downloadButton" value="Download">
    <input type="button" id="abortButton" value="Abort">
</label>
<section>
    <div id="progress">
        <div id="progressBar"></div>
    </div>
    <p id="speedOutput">0</p>
    <p id="speedOutput2">0</p>
</section>
<script>
const payloadRange = document.getElementById("payloadRange");
const payloadNumber = document.getElementById("payloadNumber");
const uploadButton = document.getElementById("uploadButton");
const downloadButton = document.getElementById("downloadButton");
const abortButton = document.getElementById("abortButton");
const progressBar = document.getElementById("progressBar");
const speedOutput = document.getElementById("speedOutput");
const speedOutput2 = document.getElementById("speedOutput2");
payloadRange.addEventListener("input", e => update(e));
payloadNumber.addEventListener("input", e => update(e));

let size = 0;
let request = null;
let last = null;

function update(e) {
    if (e) { size = parseInt(e.target.value); }
    payloadRange.value = size;
    payloadNumber.value = size;
}
update();

function abort() {
    if (request != null) { request.abort(); request = null; }
    last = null;
}
abortButton.addEventListener("click", () => abort());

function progress(loaded, total) {
    let now = window.performance.now();
    if (last != null) {
        let speed = (loaded - last.size) / (now - last.time) / 1000; // megabytes per second
        speedOutput.innerText = Math.round(speed * 100) / 100 + " megabytes per second";
        speedOutput2.innerText = Math.round(speed * 8 * 100) / 100 + " megabits per second";
    }
    last = {
        time: now,
        size: loaded
    };
    progressBar.style.width = loaded / total * 100 + "%";
}
function upload(size) {
    abort();
    request = new XMLHttpRequest();
    request.open("POST", "http://localhost:8080");
    let buffer = new ArrayBuffer(size);
    request.send(buffer);
    request.addEventListener("load", (e) => {
        console.log(e);
    });
    request.addEventListener("progress", (e) => progress(e.loaded, e.total));
}
uploadButton.addEventListener("click", () => upload(size));

function download(size) {
    abort();
    request = new XMLHttpRequest();
    request.open("GET", "http://localhost:8080/" + size);
    request.send();
    request.addEventListener("load", (e) => {
        console.log(e);
    });
    request.addEventListener("progress", (e) => progress(e.loaded, e.total));
}
downloadButton.addEventListener("click", () => download(size));
</script>
</body>
</html>